{"ast":null,"code":"var _jsxFileName = \"/home/kodachi/Desktop/Frontend1/Frontend1/src/views/Lottery/components/ClaimPrizesModal/ClaimPrizesInner.tsx\",\n    _s = $RefreshSig$();\n\nimport React, { useState } from 'react';\nimport { useWeb3React } from '@web3-react/core';\nimport { Flex, Button, Text, AutoRenewIcon, PresentWonIcon } from '@pancakeswap/uikit';\nimport { useTranslation } from 'contexts/Localization';\nimport { getBalanceAmount } from 'utils/formatBalance';\nimport { callWithEstimateGas } from 'utils/calls';\nimport { useLottery, usePriceCakeBusd } from 'state/hooks';\nimport { fetchUserLotteries } from 'state/lottery';\nimport { useAppDispatch } from 'state';\nimport Balance from 'components/Balance';\nimport useToast from 'hooks/useToast';\nimport { useLotteryV2Contract } from 'hooks/useContract';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\n\nconst ClaimInnerContainer = ({\n  onSuccess,\n  roundsToClaim\n}) => {\n  _s();\n\n  const {\n    account\n  } = useWeb3React();\n  const {\n    t\n  } = useTranslation();\n  const dispatch = useAppDispatch();\n  const {\n    maxNumberTicketsPerBuyOrClaim\n  } = useLottery();\n  const {\n    toastSuccess,\n    toastError\n  } = useToast();\n  const [activeClaimIndex, setActiveClaimIndex] = useState(0);\n  const [pendingTx, setPendingTx] = useState(false);\n  const lotteryContract = useLotteryV2Contract();\n  const activeClaimData = roundsToClaim[activeClaimIndex];\n  const cakePriceBusd = usePriceCakeBusd();\n  const cakeReward = activeClaimData.cakeTotal;\n  const dollarReward = cakeReward.times(cakePriceBusd);\n  const rewardAsBalance = getBalanceAmount(cakeReward).toNumber();\n  const dollarRewardAsBalance = getBalanceAmount(dollarReward).toNumber();\n\n  const parseUnclaimedTicketDataForClaimCall = (ticketsWithUnclaimedRewards, lotteryId) => {\n    const ticketIds = ticketsWithUnclaimedRewards.map(ticket => {\n      return ticket.id;\n    });\n    const brackets = ticketsWithUnclaimedRewards.map(ticket => {\n      return ticket.rewardBracket;\n    });\n    return {\n      lotteryId,\n      ticketIds,\n      brackets\n    };\n  };\n\n  const claimTicketsCallData = parseUnclaimedTicketDataForClaimCall(activeClaimData.ticketsWithUnclaimedRewards, activeClaimData.roundId);\n  const shouldBatchRequest = maxNumberTicketsPerBuyOrClaim.lt(claimTicketsCallData.ticketIds.length);\n\n  const totalNumClaimsForRound = () => Math.ceil(roundsToClaim[activeClaimIndex].ticketsWithUnclaimedRewards.length / maxNumberTicketsPerBuyOrClaim.toNumber());\n\n  const handleProgressToNextClaim = () => {\n    if (roundsToClaim.length > activeClaimIndex + 1) {\n      // If there are still rounds to claim, move onto the next claim\n      setActiveClaimIndex(activeClaimIndex + 1);\n      dispatch(fetchUserLotteries({\n        account\n      }));\n    } else {\n      onSuccess();\n    }\n  };\n\n  const getTicketBatches = (ticketIds, brackets) => {\n    const requests = [];\n    const maxAsNumber = maxNumberTicketsPerBuyOrClaim.toNumber();\n\n    for (let i = 0; i < ticketIds.length; i += maxAsNumber) {\n      const ticketIdsSlice = ticketIds.slice(i, maxAsNumber + i);\n      const bracketsSlice = brackets.slice(i, maxAsNumber + i);\n      requests.push({\n        ticketIds: ticketIdsSlice,\n        brackets: bracketsSlice\n      });\n    }\n\n    return requests;\n  };\n\n  const handleClaim = async () => {\n    const {\n      lotteryId,\n      ticketIds,\n      brackets\n    } = claimTicketsCallData;\n    setPendingTx(true);\n\n    try {\n      const tx = await callWithEstimateGas(lotteryContract, 'claimTickets', [lotteryId, ticketIds, brackets]);\n      const receipt = await tx.wait();\n\n      if (receipt.status) {\n        toastSuccess(t('Prizes Collected!'), t('Your CAKE prizes for round %lotteryId% have been sent to your wallet', {\n          lotteryId\n        }));\n        setPendingTx(false);\n        handleProgressToNextClaim();\n      }\n    } catch (error) {\n      console.error(error);\n      toastError(t('Error'), t('%error% - Please try again.', {\n        error: error.message\n      }));\n      setPendingTx(false);\n    }\n  };\n\n  const handleBatchClaim = async () => {\n    const {\n      lotteryId,\n      ticketIds,\n      brackets\n    } = claimTicketsCallData;\n    const ticketBatches = getTicketBatches(ticketIds, brackets);\n    const transactionsToFire = ticketBatches.length;\n    const receipts = [];\n    setPendingTx(true); // eslint-disable-next-line no-restricted-syntax\n\n    for (const ticketBatch of ticketBatches) {\n      try {\n        /* eslint-disable no-await-in-loop */\n        const tx = await callWithEstimateGas(lotteryContract, 'claimTickets', [lotteryId, ticketBatch.ticketIds, ticketBatch.brackets]);\n        const receipt = await tx.wait();\n        /* eslint-enable no-await-in-loop */\n\n        if (receipt.status) {\n          // One transaction within batch has succeeded\n          receipts.push(receipt); // More transactions are to be done within the batch. Issue toast to give user feedback.\n\n          if (receipts.length !== transactionsToFire) {\n            toastSuccess(t('Prizes Collected!'), t('Claim %claimNum% of %claimTotal% for round %lotteryId% was successful. Please confirm the next transation', {\n              claimNum: receipts.length,\n              claimTotal: transactionsToFire,\n              lotteryId\n            }));\n          }\n        }\n      } catch (error) {\n        console.error(error);\n        toastError(t('Error'), t('%error% - Please try again.', {\n          error: error.message\n        }));\n      }\n    } // Batch is finished\n\n\n    if (receipts.length === transactionsToFire) {\n      setPendingTx(false);\n      toastSuccess(t('Prizes Collected!'), t('Your CAKE prizes for round %lotteryId% have been sent to your wallet', {\n        lotteryId\n      }));\n      handleProgressToNextClaim();\n    }\n  };\n\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(Flex, {\n      flexDirection: \"column\",\n      children: [/*#__PURE__*/_jsxDEV(Text, {\n        mb: \"4px\",\n        textAlign: ['center', null, 'left'],\n        children: t('You won')\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 159,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Flex, {\n        alignItems: ['flex-start', null, 'center'],\n        justifyContent: ['flex-start', null, 'space-between'],\n        flexDirection: ['column', null, 'row'],\n        children: [/*#__PURE__*/_jsxDEV(Balance, {\n          textAlign: ['center', null, 'left'],\n          lineHeight: \"1.1\",\n          value: rewardAsBalance,\n          fontSize: \"44px\",\n          bold: true,\n          color: \"secondary\",\n          unit: \" CAKE!\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 167,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(PresentWonIcon, {\n          ml: ['0', null, '12px'],\n          width: \"64px\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 176,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 162,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Balance, {\n        mt: ['12px', null, '0'],\n        textAlign: ['center', null, 'left'],\n        value: dollarRewardAsBalance,\n        fontSize: \"12px\",\n        color: \"textSubtle\",\n        unit: \" USD\",\n        prefix: \"~\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 178,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 158,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Flex, {\n      alignItems: \"center\",\n      justifyContent: \"center\",\n      children: /*#__PURE__*/_jsxDEV(Text, {\n        mt: \"8px\",\n        fontSize: \"12px\",\n        color: \"textSubtle\",\n        children: [t('Round'), \" #\", activeClaimData.roundId]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 190,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 189,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Flex, {\n      alignItems: \"center\",\n      justifyContent: \"center\",\n      children: /*#__PURE__*/_jsxDEV(Button, {\n        isLoading: pendingTx,\n        endIcon: pendingTx ? /*#__PURE__*/_jsxDEV(AutoRenewIcon, {\n          spin: true,\n          color: \"currentColor\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 197,\n          columnNumber: 32\n        }, this) : null,\n        mt: \"20px\",\n        width: \"100%\",\n        onClick: () => shouldBatchRequest ? handleBatchClaim() : handleClaim(),\n        children: [pendingTx ? t('Claiming') : t('Claim'), \" \", totalNumClaimsForRound() > 1 ? `(${totalNumClaimsForRound()})` : '']\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 195,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 194,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true);\n};\n\n_s(ClaimInnerContainer, \"fS2KkTRupKxLd6wxgZG9HsRS1dY=\", false, function () {\n  return [useWeb3React, useTranslation, useAppDispatch, useLottery, useToast, useLotteryV2Contract, usePriceCakeBusd];\n});\n\n_c = ClaimInnerContainer;\nexport default ClaimInnerContainer;\n\nvar _c;\n\n$RefreshReg$(_c, \"ClaimInnerContainer\");","map":{"version":3,"sources":["/home/kodachi/Desktop/Frontend1/Frontend1/src/views/Lottery/components/ClaimPrizesModal/ClaimPrizesInner.tsx"],"names":["React","useState","useWeb3React","Flex","Button","Text","AutoRenewIcon","PresentWonIcon","useTranslation","getBalanceAmount","callWithEstimateGas","useLottery","usePriceCakeBusd","fetchUserLotteries","useAppDispatch","Balance","useToast","useLotteryV2Contract","ClaimInnerContainer","onSuccess","roundsToClaim","account","t","dispatch","maxNumberTicketsPerBuyOrClaim","toastSuccess","toastError","activeClaimIndex","setActiveClaimIndex","pendingTx","setPendingTx","lotteryContract","activeClaimData","cakePriceBusd","cakeReward","cakeTotal","dollarReward","times","rewardAsBalance","toNumber","dollarRewardAsBalance","parseUnclaimedTicketDataForClaimCall","ticketsWithUnclaimedRewards","lotteryId","ticketIds","map","ticket","id","brackets","rewardBracket","claimTicketsCallData","roundId","shouldBatchRequest","lt","length","totalNumClaimsForRound","Math","ceil","handleProgressToNextClaim","getTicketBatches","requests","maxAsNumber","i","ticketIdsSlice","slice","bracketsSlice","push","handleClaim","tx","receipt","wait","status","error","console","message","handleBatchClaim","ticketBatches","transactionsToFire","receipts","ticketBatch","claimNum","claimTotal"],"mappings":";;;AAAA,OAAOA,KAAP,IAAgBC,QAAhB,QAAgC,OAAhC;AACA,SAASC,YAAT,QAA6B,kBAA7B;AACA,SAASC,IAAT,EAAeC,MAAf,EAAuBC,IAAvB,EAA6BC,aAA7B,EAA4CC,cAA5C,QAAkE,oBAAlE;AACA,SAASC,cAAT,QAA+B,uBAA/B;AAEA,SAASC,gBAAT,QAAiC,qBAAjC;AACA,SAASC,mBAAT,QAAoC,aAApC;AACA,SAASC,UAAT,EAAqBC,gBAArB,QAA6C,aAA7C;AACA,SAASC,kBAAT,QAAmC,eAAnC;AACA,SAASC,cAAT,QAA+B,OAA/B;AACA,OAAOC,OAAP,MAAoB,oBAApB;AACA,OAAOC,QAAP,MAAqB,gBAArB;AACA,SAASC,oBAAT,QAAqC,mBAArC;;;;AAOA,MAAMC,mBAA8C,GAAG,CAAC;AAAEC,EAAAA,SAAF;AAAaC,EAAAA;AAAb,CAAD,KAAkC;AAAA;;AACvF,QAAM;AAAEC,IAAAA;AAAF,MAAcnB,YAAY,EAAhC;AACA,QAAM;AAAEoB,IAAAA;AAAF,MAAQd,cAAc,EAA5B;AACA,QAAMe,QAAQ,GAAGT,cAAc,EAA/B;AACA,QAAM;AAAEU,IAAAA;AAAF,MAAoCb,UAAU,EAApD;AACA,QAAM;AAAEc,IAAAA,YAAF;AAAgBC,IAAAA;AAAhB,MAA+BV,QAAQ,EAA7C;AACA,QAAM,CAACW,gBAAD,EAAmBC,mBAAnB,IAA0C3B,QAAQ,CAAC,CAAD,CAAxD;AACA,QAAM,CAAC4B,SAAD,EAAYC,YAAZ,IAA4B7B,QAAQ,CAAC,KAAD,CAA1C;AACA,QAAM8B,eAAe,GAAGd,oBAAoB,EAA5C;AACA,QAAMe,eAAe,GAAGZ,aAAa,CAACO,gBAAD,CAArC;AAEA,QAAMM,aAAa,GAAGrB,gBAAgB,EAAtC;AACA,QAAMsB,UAAU,GAAGF,eAAe,CAACG,SAAnC;AACA,QAAMC,YAAY,GAAGF,UAAU,CAACG,KAAX,CAAiBJ,aAAjB,CAArB;AACA,QAAMK,eAAe,GAAG7B,gBAAgB,CAACyB,UAAD,CAAhB,CAA6BK,QAA7B,EAAxB;AACA,QAAMC,qBAAqB,GAAG/B,gBAAgB,CAAC2B,YAAD,CAAhB,CAA+BG,QAA/B,EAA9B;;AAEA,QAAME,oCAAoC,GAAG,CAACC,2BAAD,EAA+CC,SAA/C,KAAqE;AAChH,UAAMC,SAAS,GAAGF,2BAA2B,CAACG,GAA5B,CAAiCC,MAAD,IAAY;AAC5D,aAAOA,MAAM,CAACC,EAAd;AACD,KAFiB,CAAlB;AAGA,UAAMC,QAAQ,GAAGN,2BAA2B,CAACG,GAA5B,CAAiCC,MAAD,IAAY;AAC3D,aAAOA,MAAM,CAACG,aAAd;AACD,KAFgB,CAAjB;AAGA,WAAO;AAAEN,MAAAA,SAAF;AAAaC,MAAAA,SAAb;AAAwBI,MAAAA;AAAxB,KAAP;AACD,GARD;;AAUA,QAAME,oBAAoB,GAAGT,oCAAoC,CAC/DT,eAAe,CAACU,2BAD+C,EAE/DV,eAAe,CAACmB,OAF+C,CAAjE;AAKA,QAAMC,kBAAkB,GAAG5B,6BAA6B,CAAC6B,EAA9B,CAAiCH,oBAAoB,CAACN,SAArB,CAA+BU,MAAhE,CAA3B;;AAEA,QAAMC,sBAAsB,GAAG,MAC7BC,IAAI,CAACC,IAAL,CACErC,aAAa,CAACO,gBAAD,CAAb,CAAgCe,2BAAhC,CAA4DY,MAA5D,GAAqE9B,6BAA6B,CAACe,QAA9B,EADvE,CADF;;AAKA,QAAMmB,yBAAyB,GAAG,MAAM;AACtC,QAAItC,aAAa,CAACkC,MAAd,GAAuB3B,gBAAgB,GAAG,CAA9C,EAAiD;AAC/C;AACAC,MAAAA,mBAAmB,CAACD,gBAAgB,GAAG,CAApB,CAAnB;AACAJ,MAAAA,QAAQ,CAACV,kBAAkB,CAAC;AAAEQ,QAAAA;AAAF,OAAD,CAAnB,CAAR;AACD,KAJD,MAIO;AACLF,MAAAA,SAAS;AACV;AACF,GARD;;AAUA,QAAMwC,gBAAgB,GAAG,CAACf,SAAD,EAAsBI,QAAtB,KAA4F;AACnH,UAAMY,QAAQ,GAAG,EAAjB;AACA,UAAMC,WAAW,GAAGrC,6BAA6B,CAACe,QAA9B,EAApB;;AAEA,SAAK,IAAIuB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGlB,SAAS,CAACU,MAA9B,EAAsCQ,CAAC,IAAID,WAA3C,EAAwD;AACtD,YAAME,cAAc,GAAGnB,SAAS,CAACoB,KAAV,CAAgBF,CAAhB,EAAmBD,WAAW,GAAGC,CAAjC,CAAvB;AACA,YAAMG,aAAa,GAAGjB,QAAQ,CAACgB,KAAT,CAAeF,CAAf,EAAkBD,WAAW,GAAGC,CAAhC,CAAtB;AACAF,MAAAA,QAAQ,CAACM,IAAT,CAAc;AAAEtB,QAAAA,SAAS,EAAEmB,cAAb;AAA6Bf,QAAAA,QAAQ,EAAEiB;AAAvC,OAAd;AACD;;AAED,WAAOL,QAAP;AACD,GAXD;;AAaA,QAAMO,WAAW,GAAG,YAAY;AAC9B,UAAM;AAAExB,MAAAA,SAAF;AAAaC,MAAAA,SAAb;AAAwBI,MAAAA;AAAxB,QAAqCE,oBAA3C;AACApB,IAAAA,YAAY,CAAC,IAAD,CAAZ;;AACA,QAAI;AACF,YAAMsC,EAAE,GAAG,MAAM1D,mBAAmB,CAACqB,eAAD,EAAkB,cAAlB,EAAkC,CAACY,SAAD,EAAYC,SAAZ,EAAuBI,QAAvB,CAAlC,CAApC;AACA,YAAMqB,OAAO,GAAG,MAAMD,EAAE,CAACE,IAAH,EAAtB;;AACA,UAAID,OAAO,CAACE,MAAZ,EAAoB;AAClB9C,QAAAA,YAAY,CACVH,CAAC,CAAC,mBAAD,CADS,EAEVA,CAAC,CAAC,sEAAD,EAAyE;AAAEqB,UAAAA;AAAF,SAAzE,CAFS,CAAZ;AAIAb,QAAAA,YAAY,CAAC,KAAD,CAAZ;AACA4B,QAAAA,yBAAyB;AAC1B;AACF,KAXD,CAWE,OAAOc,KAAP,EAAc;AACdC,MAAAA,OAAO,CAACD,KAAR,CAAcA,KAAd;AACA9C,MAAAA,UAAU,CAACJ,CAAC,CAAC,OAAD,CAAF,EAAaA,CAAC,CAAC,6BAAD,EAAgC;AAAEkD,QAAAA,KAAK,EAAEA,KAAK,CAACE;AAAf,OAAhC,CAAd,CAAV;AACA5C,MAAAA,YAAY,CAAC,KAAD,CAAZ;AACD;AACF,GAnBD;;AAqBA,QAAM6C,gBAAgB,GAAG,YAAY;AACnC,UAAM;AAAEhC,MAAAA,SAAF;AAAaC,MAAAA,SAAb;AAAwBI,MAAAA;AAAxB,QAAqCE,oBAA3C;AACA,UAAM0B,aAAa,GAAGjB,gBAAgB,CAACf,SAAD,EAAYI,QAAZ,CAAtC;AACA,UAAM6B,kBAAkB,GAAGD,aAAa,CAACtB,MAAzC;AACA,UAAMwB,QAAQ,GAAG,EAAjB;AACAhD,IAAAA,YAAY,CAAC,IAAD,CAAZ,CALmC,CAMnC;;AACA,SAAK,MAAMiD,WAAX,IAA0BH,aAA1B,EAAyC;AACvC,UAAI;AACF;AACA,cAAMR,EAAE,GAAG,MAAM1D,mBAAmB,CAACqB,eAAD,EAAkB,cAAlB,EAAkC,CACpEY,SADoE,EAEpEoC,WAAW,CAACnC,SAFwD,EAGpEmC,WAAW,CAAC/B,QAHwD,CAAlC,CAApC;AAKA,cAAMqB,OAAO,GAAG,MAAMD,EAAE,CAACE,IAAH,EAAtB;AACA;;AACA,YAAID,OAAO,CAACE,MAAZ,EAAoB;AAClB;AACAO,UAAAA,QAAQ,CAACZ,IAAT,CAAcG,OAAd,EAFkB,CAIlB;;AACA,cAAIS,QAAQ,CAACxB,MAAT,KAAoBuB,kBAAxB,EAA4C;AAC1CpD,YAAAA,YAAY,CACVH,CAAC,CAAC,mBAAD,CADS,EAEVA,CAAC,CACC,2GADD,EAEC;AACE0D,cAAAA,QAAQ,EAAEF,QAAQ,CAACxB,MADrB;AAEE2B,cAAAA,UAAU,EAAEJ,kBAFd;AAGElC,cAAAA;AAHF,aAFD,CAFS,CAAZ;AAWD;AACF;AACF,OA5BD,CA4BE,OAAO6B,KAAP,EAAc;AACdC,QAAAA,OAAO,CAACD,KAAR,CAAcA,KAAd;AACA9C,QAAAA,UAAU,CAACJ,CAAC,CAAC,OAAD,CAAF,EAAaA,CAAC,CAAC,6BAAD,EAAgC;AAAEkD,UAAAA,KAAK,EAAEA,KAAK,CAACE;AAAf,SAAhC,CAAd,CAAV;AACD;AACF,KAxCkC,CA0CnC;;;AACA,QAAII,QAAQ,CAACxB,MAAT,KAAoBuB,kBAAxB,EAA4C;AAC1C/C,MAAAA,YAAY,CAAC,KAAD,CAAZ;AACAL,MAAAA,YAAY,CACVH,CAAC,CAAC,mBAAD,CADS,EAEVA,CAAC,CAAC,sEAAD,EAAyE;AAAEqB,QAAAA;AAAF,OAAzE,CAFS,CAAZ;AAIAe,MAAAA,yBAAyB;AAC1B;AACF,GAnDD;;AAqDA,sBACE;AAAA,4BACE,QAAC,IAAD;AAAM,MAAA,aAAa,EAAC,QAApB;AAAA,8BACE,QAAC,IAAD;AAAM,QAAA,EAAE,EAAC,KAAT;AAAe,QAAA,SAAS,EAAE,CAAC,QAAD,EAAW,IAAX,EAAiB,MAAjB,CAA1B;AAAA,kBACGpC,CAAC,CAAC,SAAD;AADJ;AAAA;AAAA;AAAA;AAAA,cADF,eAIE,QAAC,IAAD;AACE,QAAA,UAAU,EAAE,CAAC,YAAD,EAAe,IAAf,EAAqB,QAArB,CADd;AAEE,QAAA,cAAc,EAAE,CAAC,YAAD,EAAe,IAAf,EAAqB,eAArB,CAFlB;AAGE,QAAA,aAAa,EAAE,CAAC,QAAD,EAAW,IAAX,EAAiB,KAAjB,CAHjB;AAAA,gCAKE,QAAC,OAAD;AACE,UAAA,SAAS,EAAE,CAAC,QAAD,EAAW,IAAX,EAAiB,MAAjB,CADb;AAEE,UAAA,UAAU,EAAC,KAFb;AAGE,UAAA,KAAK,EAAEgB,eAHT;AAIE,UAAA,QAAQ,EAAC,MAJX;AAKE,UAAA,IAAI,MALN;AAME,UAAA,KAAK,EAAC,WANR;AAOE,UAAA,IAAI,EAAC;AAPP;AAAA;AAAA;AAAA;AAAA,gBALF,eAcE,QAAC,cAAD;AAAgB,UAAA,EAAE,EAAE,CAAC,GAAD,EAAM,IAAN,EAAY,MAAZ,CAApB;AAAyC,UAAA,KAAK,EAAC;AAA/C;AAAA;AAAA;AAAA;AAAA,gBAdF;AAAA;AAAA;AAAA;AAAA;AAAA,cAJF,eAoBE,QAAC,OAAD;AACE,QAAA,EAAE,EAAE,CAAC,MAAD,EAAS,IAAT,EAAe,GAAf,CADN;AAEE,QAAA,SAAS,EAAE,CAAC,QAAD,EAAW,IAAX,EAAiB,MAAjB,CAFb;AAGE,QAAA,KAAK,EAAEE,qBAHT;AAIE,QAAA,QAAQ,EAAC,MAJX;AAKE,QAAA,KAAK,EAAC,YALR;AAME,QAAA,IAAI,EAAC,MANP;AAOE,QAAA,MAAM,EAAC;AAPT;AAAA;AAAA;AAAA;AAAA,cApBF;AAAA;AAAA;AAAA;AAAA;AAAA,YADF,eAgCE,QAAC,IAAD;AAAM,MAAA,UAAU,EAAC,QAAjB;AAA0B,MAAA,cAAc,EAAC,QAAzC;AAAA,6BACE,QAAC,IAAD;AAAM,QAAA,EAAE,EAAC,KAAT;AAAe,QAAA,QAAQ,EAAC,MAAxB;AAA+B,QAAA,KAAK,EAAC,YAArC;AAAA,mBACGlB,CAAC,CAAC,OAAD,CADJ,QACiBU,eAAe,CAACmB,OADjC;AAAA;AAAA;AAAA;AAAA;AAAA;AADF;AAAA;AAAA;AAAA;AAAA,YAhCF,eAqCE,QAAC,IAAD;AAAM,MAAA,UAAU,EAAC,QAAjB;AAA0B,MAAA,cAAc,EAAC,QAAzC;AAAA,6BACE,QAAC,MAAD;AACE,QAAA,SAAS,EAAEtB,SADb;AAEE,QAAA,OAAO,EAAEA,SAAS,gBAAG,QAAC,aAAD;AAAe,UAAA,IAAI,MAAnB;AAAoB,UAAA,KAAK,EAAC;AAA1B;AAAA;AAAA;AAAA;AAAA,gBAAH,GAAiD,IAFrE;AAGE,QAAA,EAAE,EAAC,MAHL;AAIE,QAAA,KAAK,EAAC,MAJR;AAKE,QAAA,OAAO,EAAE,MAAOuB,kBAAkB,GAAGuB,gBAAgB,EAAnB,GAAwBR,WAAW,EALvE;AAAA,mBAOGtC,SAAS,GAAGP,CAAC,CAAC,UAAD,CAAJ,GAAmBA,CAAC,CAAC,OAAD,CAPhC,OAO4CiC,sBAAsB,KAAK,CAA3B,GAAgC,IAAGA,sBAAsB,EAAG,GAA5D,GAAiE,EAP7G;AAAA;AAAA;AAAA;AAAA;AAAA;AADF;AAAA;AAAA;AAAA;AAAA,YArCF;AAAA,kBADF;AAmDD,CA3LD;;GAAMrC,mB;UACgBhB,Y,EACNM,c,EACGM,c,EACyBH,U,EACLK,Q,EAGbC,oB,EAGFL,gB;;;KAXlBM,mB;AA6LN,eAAeA,mBAAf","sourcesContent":["import React, { useState } from 'react'\nimport { useWeb3React } from '@web3-react/core'\nimport { Flex, Button, Text, AutoRenewIcon, PresentWonIcon } from '@pancakeswap/uikit'\nimport { useTranslation } from 'contexts/Localization'\nimport { LotteryTicket, LotteryTicketClaimData } from 'config/constants/types'\nimport { getBalanceAmount } from 'utils/formatBalance'\nimport { callWithEstimateGas } from 'utils/calls'\nimport { useLottery, usePriceCakeBusd } from 'state/hooks'\nimport { fetchUserLotteries } from 'state/lottery'\nimport { useAppDispatch } from 'state'\nimport Balance from 'components/Balance'\nimport useToast from 'hooks/useToast'\nimport { useLotteryV2Contract } from 'hooks/useContract'\n\ninterface ClaimInnerProps {\n  roundsToClaim: LotteryTicketClaimData[]\n  onSuccess?: () => void\n}\n\nconst ClaimInnerContainer: React.FC<ClaimInnerProps> = ({ onSuccess, roundsToClaim }) => {\n  const { account } = useWeb3React()\n  const { t } = useTranslation()\n  const dispatch = useAppDispatch()\n  const { maxNumberTicketsPerBuyOrClaim } = useLottery()\n  const { toastSuccess, toastError } = useToast()\n  const [activeClaimIndex, setActiveClaimIndex] = useState(0)\n  const [pendingTx, setPendingTx] = useState(false)\n  const lotteryContract = useLotteryV2Contract()\n  const activeClaimData = roundsToClaim[activeClaimIndex]\n\n  const cakePriceBusd = usePriceCakeBusd()\n  const cakeReward = activeClaimData.cakeTotal\n  const dollarReward = cakeReward.times(cakePriceBusd)\n  const rewardAsBalance = getBalanceAmount(cakeReward).toNumber()\n  const dollarRewardAsBalance = getBalanceAmount(dollarReward).toNumber()\n\n  const parseUnclaimedTicketDataForClaimCall = (ticketsWithUnclaimedRewards: LotteryTicket[], lotteryId: string) => {\n    const ticketIds = ticketsWithUnclaimedRewards.map((ticket) => {\n      return ticket.id\n    })\n    const brackets = ticketsWithUnclaimedRewards.map((ticket) => {\n      return ticket.rewardBracket\n    })\n    return { lotteryId, ticketIds, brackets }\n  }\n\n  const claimTicketsCallData = parseUnclaimedTicketDataForClaimCall(\n    activeClaimData.ticketsWithUnclaimedRewards,\n    activeClaimData.roundId,\n  )\n\n  const shouldBatchRequest = maxNumberTicketsPerBuyOrClaim.lt(claimTicketsCallData.ticketIds.length)\n\n  const totalNumClaimsForRound = () =>\n    Math.ceil(\n      roundsToClaim[activeClaimIndex].ticketsWithUnclaimedRewards.length / maxNumberTicketsPerBuyOrClaim.toNumber(),\n    )\n\n  const handleProgressToNextClaim = () => {\n    if (roundsToClaim.length > activeClaimIndex + 1) {\n      // If there are still rounds to claim, move onto the next claim\n      setActiveClaimIndex(activeClaimIndex + 1)\n      dispatch(fetchUserLotteries({ account }))\n    } else {\n      onSuccess()\n    }\n  }\n\n  const getTicketBatches = (ticketIds: string[], brackets: number[]): { ticketIds: string[]; brackets: number[] }[] => {\n    const requests = []\n    const maxAsNumber = maxNumberTicketsPerBuyOrClaim.toNumber()\n\n    for (let i = 0; i < ticketIds.length; i += maxAsNumber) {\n      const ticketIdsSlice = ticketIds.slice(i, maxAsNumber + i)\n      const bracketsSlice = brackets.slice(i, maxAsNumber + i)\n      requests.push({ ticketIds: ticketIdsSlice, brackets: bracketsSlice })\n    }\n\n    return requests\n  }\n\n  const handleClaim = async () => {\n    const { lotteryId, ticketIds, brackets } = claimTicketsCallData\n    setPendingTx(true)\n    try {\n      const tx = await callWithEstimateGas(lotteryContract, 'claimTickets', [lotteryId, ticketIds, brackets])\n      const receipt = await tx.wait()\n      if (receipt.status) {\n        toastSuccess(\n          t('Prizes Collected!'),\n          t('Your CAKE prizes for round %lotteryId% have been sent to your wallet', { lotteryId }),\n        )\n        setPendingTx(false)\n        handleProgressToNextClaim()\n      }\n    } catch (error) {\n      console.error(error)\n      toastError(t('Error'), t('%error% - Please try again.', { error: error.message }))\n      setPendingTx(false)\n    }\n  }\n\n  const handleBatchClaim = async () => {\n    const { lotteryId, ticketIds, brackets } = claimTicketsCallData\n    const ticketBatches = getTicketBatches(ticketIds, brackets)\n    const transactionsToFire = ticketBatches.length\n    const receipts = []\n    setPendingTx(true)\n    // eslint-disable-next-line no-restricted-syntax\n    for (const ticketBatch of ticketBatches) {\n      try {\n        /* eslint-disable no-await-in-loop */\n        const tx = await callWithEstimateGas(lotteryContract, 'claimTickets', [\n          lotteryId,\n          ticketBatch.ticketIds,\n          ticketBatch.brackets,\n        ])\n        const receipt = await tx.wait()\n        /* eslint-enable no-await-in-loop */\n        if (receipt.status) {\n          // One transaction within batch has succeeded\n          receipts.push(receipt)\n\n          // More transactions are to be done within the batch. Issue toast to give user feedback.\n          if (receipts.length !== transactionsToFire) {\n            toastSuccess(\n              t('Prizes Collected!'),\n              t(\n                'Claim %claimNum% of %claimTotal% for round %lotteryId% was successful. Please confirm the next transation',\n                {\n                  claimNum: receipts.length,\n                  claimTotal: transactionsToFire,\n                  lotteryId,\n                },\n              ),\n            )\n          }\n        }\n      } catch (error) {\n        console.error(error)\n        toastError(t('Error'), t('%error% - Please try again.', { error: error.message }))\n      }\n    }\n\n    // Batch is finished\n    if (receipts.length === transactionsToFire) {\n      setPendingTx(false)\n      toastSuccess(\n        t('Prizes Collected!'),\n        t('Your CAKE prizes for round %lotteryId% have been sent to your wallet', { lotteryId }),\n      )\n      handleProgressToNextClaim()\n    }\n  }\n\n  return (\n    <>\n      <Flex flexDirection=\"column\">\n        <Text mb=\"4px\" textAlign={['center', null, 'left']}>\n          {t('You won')}\n        </Text>\n        <Flex\n          alignItems={['flex-start', null, 'center']}\n          justifyContent={['flex-start', null, 'space-between']}\n          flexDirection={['column', null, 'row']}\n        >\n          <Balance\n            textAlign={['center', null, 'left']}\n            lineHeight=\"1.1\"\n            value={rewardAsBalance}\n            fontSize=\"44px\"\n            bold\n            color=\"secondary\"\n            unit=\" CAKE!\"\n          />\n          <PresentWonIcon ml={['0', null, '12px']} width=\"64px\" />\n        </Flex>\n        <Balance\n          mt={['12px', null, '0']}\n          textAlign={['center', null, 'left']}\n          value={dollarRewardAsBalance}\n          fontSize=\"12px\"\n          color=\"textSubtle\"\n          unit=\" USD\"\n          prefix=\"~\"\n        />\n      </Flex>\n\n      <Flex alignItems=\"center\" justifyContent=\"center\">\n        <Text mt=\"8px\" fontSize=\"12px\" color=\"textSubtle\">\n          {t('Round')} #{activeClaimData.roundId}\n        </Text>\n      </Flex>\n      <Flex alignItems=\"center\" justifyContent=\"center\">\n        <Button\n          isLoading={pendingTx}\n          endIcon={pendingTx ? <AutoRenewIcon spin color=\"currentColor\" /> : null}\n          mt=\"20px\"\n          width=\"100%\"\n          onClick={() => (shouldBatchRequest ? handleBatchClaim() : handleClaim())}\n        >\n          {pendingTx ? t('Claiming') : t('Claim')} {totalNumClaimsForRound() > 1 ? `(${totalNumClaimsForRound()})` : ''}\n        </Button>\n      </Flex>\n    </>\n  )\n}\n\nexport default ClaimInnerContainer\n"]},"metadata":{},"sourceType":"module"}